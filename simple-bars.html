<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cross Validation Accuracy Chart</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    #chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .editable-label {
      cursor: pointer;
      user-select: none;
    }
    .editable-label:hover {
      fill: #3498db;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="chart-container">
    <h3 style="text-align: center; margin-bottom: 20px; color: #333;">Cross Validation Accuracy (%)</h3>
  </div>

  <script>
    // 等待页面加载完成
    document.addEventListener('DOMContentLoaded', function() {
      createChart();
    });

    function createChart() {
      try {
        // 1. 定义数据
        const data = [
          { model: "BERT", values: [74.4, 64.8] },
          { model: "RoBERTa", values: [81.9, 65.5] },
          { model: "BART", values: [73.1, 63.5] }
        ];

        // 2. 设置画布尺寸与边距
        const margin = { top: 60, right: 20, bottom: 40, left: 40 };
        const width = 600 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        // 3. 创建SVG容器
        const svg = d3.select("#chart-container")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left}, ${margin.top})`);

        // 4. 定义比例尺
        const x = d3.scaleBand()
          .domain(data.map(d => d.model))
          .range([0, width])
          .padding(0.4);

        const y = d3.scaleLinear()
          .domain([0, 100])
          .range([height, 0]);

        // 5. 绘制坐标轴
        svg.append("g")
          .attr("transform", `translate(0, ${height})`)
          .call(d3.axisBottom(x));

        svg.append("g")
          .call(d3.axisLeft(y));

        // 6. 绘制实心柱子
        const solidBars = svg.selectAll(".solid-bar")
          .data(data)
          .enter()
          .append("rect")
          .attr("class", "solid-bar")
          .attr("x", d => x(d.model) + x.bandwidth() * 0.1)
          .attr("y", d => y(d.values[0]))
          .attr("width", x.bandwidth() * 0.35)
          .attr("height", d => height - y(d.values[0]))
          .attr("fill", "#f7c17b");

        // 7. 绘制虚线柱子
        const dashedBars = svg.selectAll(".dashed-bar")
          .data(data)
          .enter()
          .append("rect")
          .attr("class", "dashed-bar")
          .attr("x", d => x(d.model) + x.bandwidth() * 0.55)
          .attr("y", d => y(d.values[1]))
          .attr("width", x.bandwidth() * 0.35)
          .attr("height", d => height - y(d.values[1]))
          .attr("fill", "none")
          .attr("stroke", "#f7d78b")
          .attr("stroke-dasharray", "5,3");

        // 8. 添加数值标签
        const solidLabels = svg.selectAll(".solid-label")
          .data(data)
          .enter()
          .append("text")
          .attr("class", "solid-label editable-label")
          .attr("x", d => x(d.model) + x.bandwidth() * 0.1 + (x.bandwidth() * 0.35)/2)
          .attr("y", d => y(d.values[0]) - 5)
          .attr("text-anchor", "middle")
          .text(d => d.values[0])
          .on("click", function(event, d) {
            editValue(this, d, 0, solidBars, dashedBars, y, height);
          });

        const dashedLabels = svg.selectAll(".dashed-label")
          .data(data)
          .enter()
          .append("text")
          .attr("class", "dashed-label editable-label")
          .attr("x", d => x(d.model) + x.bandwidth() * 0.55 + (x.bandwidth() * 0.35)/2)
          .attr("y", d => y(d.values[1]) - 5)
          .attr("text-anchor", "middle")
          .text(d => d.values[1])
          .on("click", function(event, d) {
            editValue(this, d, 1, solidBars, dashedBars, y, height);
          });

        // 9. 添加图例
        const legend = svg.append("g")
          .attr("transform", `translate(${width/2 - 80}, -30)`);

        legend.append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 15)
          .attr("height", 15)
          .attr("fill", "#f7c17b");

        legend.append("text")
          .attr("x", 20)
          .attr("y", 12)
          .text("First Value")
          .style("font-size", "12px");

        legend.append("rect")
          .attr("x", 100)
          .attr("y", 0)
          .attr("width", 15)
          .attr("height", 15)
          .attr("fill", "none")
          .attr("stroke", "#f7d78b")
          .attr("stroke-dasharray", "5,3");

        legend.append("text")
          .attr("x", 120)
          .attr("y", 12)
          .text("Second Value")
          .style("font-size", "12px");

      } catch (error) {
        console.error('Chart creation error:', error);
        document.getElementById('chart-container').innerHTML = 
          '<p style="color: red; text-align: center;">图表加载失败: ' + error.message + '</p>';
      }
    }

    function editValue(element, d, index, solidBars, dashedBars, y, height) {
      const currentValue = d.values[index];
      const input = document.createElement("input");
      input.type = "number";
      input.value = currentValue;
      input.style.position = "fixed";
      input.style.width = "60px";
      input.style.textAlign = "center";
      input.style.zIndex = "1000";
      input.style.backgroundColor = "white";
      input.style.border = "2px solid #3498db";
      input.style.borderRadius = "3px";
      input.style.padding = "5px";
      input.style.boxShadow = "0 2px 10px rgba(0,0,0,0.2)";
      
      // 简单定位在屏幕中央
      input.style.left = "50%";
      input.style.top = "50%";
      input.style.transform = "translate(-50%, -50%)";
      
      document.body.appendChild(input);
      input.focus();
      input.select();
      
      function handleInput() {
        const newValue = parseFloat(input.value);
        if (!isNaN(newValue) && newValue >= 0 && newValue <= 100) {
          d.values[index] = newValue;
          
          if (index === 0) {
            solidBars.filter(bar => bar.model === d.model)
              .transition()
              .duration(500)
              .attr("y", y(newValue))
              .attr("height", height - y(newValue));
          } else {
            dashedBars.filter(bar => bar.model === d.model)
              .transition()
              .duration(500)
              .attr("y", y(newValue))
              .attr("height", height - y(newValue));
          }
          
          d3.select(element)
            .text(newValue.toFixed(1))
            .attr("y", y(newValue) - 5);
        }
        
        document.body.removeChild(input);
        document.removeEventListener("keydown", handleKeyDown);
      }
      
      function handleKeyDown(e) {
        if (e.key === "Enter") {
          handleInput();
        } else if (e.key === "Escape") {
          document.body.removeChild(input);
          document.removeEventListener("keydown", handleKeyDown);
        }
      }
      
      input.addEventListener("blur", handleInput);
      document.addEventListener("keydown", handleKeyDown);
    }
  </script>
</body>
</html>
